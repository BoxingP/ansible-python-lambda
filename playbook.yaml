- name: get hosts facts
  hosts: all
  gather_facts: yes

- name: deploy lambda function
  hosts: localhost
  gather_facts: no
  vars:
    aws_region: cn-northwest-1
    git_repo: git@github.com:BoxingP/aws-lambda-python-function.git
    lambda_function_name: start_stop_instance
    zip_name: '{{ lambda_function_name }}.zip'
    lambda_function_directory: workspace
    s3_bucket_name: aws-lambda-functions
    s3_object_name: '{{ zip_name }}'
    email_address: creator@example.com
    virtualenv: '{{ hostvars[inventory_hostname].ansible_env.HOME }}/.virtualenvs/ansible-lambda-python-env'
    cron_schedule: 'cron(0 1-10/9 ? * MON-FRI *)'  #UTC
    schedule_description: 'Weekdays at 0900 and 1800'
  vars_files:
    - vars/aws_credentials.yaml
  tasks:
    - name: init server environment
      block:
        - include_role:
            name: 'update_{{ ansible_distribution|lower }}_environment'
        - include_role:
            name: create_python_virtualenv
        - include_tasks: tasks/init_workspace.yaml
          vars:
            workspace_directory: '{{ lambda_function_directory }}'
        - include_role:
            name: build_zip_file
          vars:
            files_need_to_zip_directory: '{{ lambda_function_directory }}'
    - name: build aws environment
      block:
        - name: load aws tags needed to add when creating resources
          include_vars:
            file: files/resource_tags.yaml
            name: aws_resource_tags
        - include_role:
            name: create_s3_bucket
          vars:
            s3_tags: '{{ aws_resource_tags }}'
        - include_role:
            name: upload_file_to_s3
        - include_role:
            name: get_s3_object_version_id
        - name: load cloudformation template parameters
          include_vars:
            file: files/lambda_function_stack_template_parameters.yaml
            name: cloudformation_template_parameters
        - include_role:
            name: create_cloudformation_stack
          vars:
            cloudformation_stack_name: "{{ lambda_function_name | replace('_','-') }}"
            cloudformation_template: files/lambda_function_stack.yaml
            cloudformation_tags: '{{ aws_resource_tags }}'
      vars:
        ansible_python_interpreter: '{{ virtualenv }}/bin/python3'
      environment:
        AWS_ACCESS_KEY_ID: '{{ dscops.aws_access_key_id }}'
        AWS_SECRET_ACCESS_KEY: '{{ dscops.aws_secret_access_key }}'
        PATH: '{{ virtualenv }}/bin:{{ hostvars[inventory_hostname].ansible_env.PATH }}'
