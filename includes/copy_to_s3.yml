- name: creat s3 bucket
  amazon.aws.s3_bucket:
    name: '{{ s3_bucket }}'
    versioning: yes
    region: '{{ aws_region }}'
    tags:
      '{{ aws_tags }}'
  vars:
    ansible_python_interpreter: '{{ virtualenv }}/bin/python3'

- name: copy package to s3
  amazon.aws.aws_s3:
    mode: put
    src: build/{{ zip_name }}
    region: '{{ aws_region }}'
    bucket: '{{ s3_bucket }}'
    object: '{{ zip_name }}'  # versioning on for bucket
  vars:
    ansible_python_interpreter: '{{ virtualenv }}/bin/python3'

- name: find the s3 version we just uploaded
  command: >
    {{ virtualenv }}/bin/aws s3api head-object
      --region {{ aws_region }}
      --bucket {{ s3_bucket }}
      --key {{ zip_name }}
  register: head_object_output
  vars:
    ansible_python_interpreter: '{{ virtualenv }}/bin/python3'

- name: set s3_version_id
  set_fact:
    s3_version_id: '{{ (head_object_output.stdout|from_json)["VersionId"] }}'
